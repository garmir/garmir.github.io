name: Create SuperClaude Framework Repository (Remote-Only)

on:
  push:
    branches:
      - main
    paths:
      - '.github/workflows/create-superclaude-repo.yml'

# Remote-Only Repository Creation
# ALL operations happen on GitHub Actions runner
# Zero local operations required
# Framework: SuperClaude v3.777

permissions:
  contents: write
  packages: write

jobs:
  create-repo-remote:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: "[1/8] Checkout Source Repository"
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: "[2/8] Install Nix"
        uses: DeterminateSystems/nix-installer-action@main

      - name: "[3/8] Setup GitHub CLI"
        run: |
          echo "=== Configuring GitHub CLI ==="
          nix-shell -p github-cli --run 'gh --version'
          nix-shell -p github-cli --run 'gh auth status'

      - name: "[4/8] Create New Repository (Remote)"
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          echo "=== Creating superclaude-framework repository ==="

          nix-shell -p github-cli --run 'gh repo create garmir/superclaude-framework \
            --public \
            --description "SuperClaude Framework - Pure Nix AI automation system with universal compliance" \
            --clone=false' || echo "Repository may already exist"

          echo "✅ Repository created"

      - name: "[5/8] Clone New Repository (Remote)"
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          echo "=== Cloning new repository on runner ==="

          cd /tmp
          nix-shell -p github-cli --run 'gh repo clone garmir/superclaude-framework'

          echo "✅ Repository cloned to /tmp/superclaude-framework"

      - name: "[6/8] Copy Framework Files (Remote)"
        run: |
          echo "=== Copying SuperClaude Framework files ==="

          cd /tmp/superclaude-framework

          # Copy core framework files from checked out source
          nix-shell -p coreutils --run 'cp -r $GITHUB_WORKSPACE/.claude/CORE .'
          nix-shell -p coreutils --run 'cp -r $GITHUB_WORKSPACE/.claude/agents .'
          nix-shell -p coreutils --run 'cp -r $GITHUB_WORKSPACE/.claude/commands .'

          # Copy Nix configuration files
          nix-shell -p coreutils --run 'cp $GITHUB_WORKSPACE/.claude/*.nix . 2>/dev/null || true'

          # Copy README from source
          nix-shell -p coreutils --run 'cp $GITHUB_WORKSPACE/.claude/README.md . 2>/dev/null || true'

          # Copy CLAUDE.md from source
          nix-shell -p coreutils --run 'cp $GITHUB_WORKSPACE/CLAUDE.md . 2>/dev/null || echo "No CLAUDE.md in source"'

          # Create simple .gitattributes
          echo "*.md linguist-documentation" > .gitattributes
          echo "*.nix linguist-language=Nix" >> .gitattributes

          echo "✅ Framework files copied"

      - name: "[7/8] Commit Framework (Remote)"
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          echo "=== Committing framework to new repository ==="

          cd /tmp/superclaude-framework

          nix-shell -p github-cli --run 'gh repo set-default garmir/superclaude-framework'

          # Configure git
          nix-shell -p git --run 'git config user.name "SuperClaude Framework"'
          nix-shell -p git --run 'git config user.email "noreply@anthropic.com"'

          # Create commit message file
          echo "init: SuperClaude Framework v3.777" > /tmp/commit-msg.txt
          echo "" >> /tmp/commit-msg.txt
          echo "Pure Nix AI automation system" >> /tmp/commit-msg.txt
          echo "" >> /tmp/commit-msg.txt
          echo "Framework migrated from garmir.github.io" >> /tmp/commit-msg.txt

          # Add and commit
          nix-shell -p git --run 'git add -A'
          nix-shell -p git --run 'git commit -F /tmp/commit-msg.txt'

          echo "✅ Changes committed"

      - name: "[8/8] Push to GitHub (Remote)"
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          echo "=== Pushing framework to GitHub ==="

          cd /tmp/superclaude-framework

          nix-shell -p git --run 'git push origin main'

          echo ""
          echo "╔═══════════════════════════════════════════════════════╗"
          echo "║                                                       ║"
          echo "║  ✅ SUPERCLAUDE FRAMEWORK REPOSITORY CREATED          ║"
          echo "║                                                       ║"
          echo "╚═══════════════════════════════════════════════════════╝"
          echo ""
          echo "Repository: https://github.com/garmir/superclaude-framework"
          echo "Language: Nix (properly classified)"
          echo "Separation: Complete (framework independent from website)"
          echo ""
          echo "All operations executed remotely on GitHub Actions runner."
